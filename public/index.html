<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>CalorieHUD 2.0</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
  <style>
    :root { --primary: #6366f1; --bg: #f5f7ff; --card: #ffffff; --text: #1e293b; }
    body { font-family: -apple-system, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; }
    
    /* Replit-Style Header & Tabs */
    .tabs { display: flex; gap: 8px; background: #e0e7ff; padding: 6px; border-radius: 16px; margin-bottom: 25px; }
    .tab { flex: 1; text-align: center; padding: 12px; border-radius: 12px; font-weight: 700; color: #6366f1; cursor: pointer; }
    .tab.active { background: white; color: #1e1b4b; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }

    /* Polished Cards */
    .card { background: var(--card); padding: 22px; border-radius: 28px; box-shadow: 0 10px 25px -5px rgba(0,0,0,0.05); margin-bottom: 20px; border: 1px solid rgba(255,255,255,0.7); }
    .card-label { font-size: 11px; color: #64748b; font-weight: 800; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px; display: flex; align-items: center; gap: 4px; }
    .card-value { font-size: 32px; font-weight: 800; letter-spacing: -1px; }
    
    /* The Percent Bar */
    .progress-container { margin-top: 15px; }
    .progress-text { display: flex; justify-content: space-between; font-size: 13px; font-weight: 700; color: #64748b; margin-bottom: 8px; }
    .progress-bg { background: #f1f5f9; height: 14px; border-radius: 10px; overflow: hidden; position: relative; }
    .progress-fill { height: 100%; background: linear-gradient(90deg, #6366f1, #818cf8); border-radius: 10px; transition: width 0.8s cubic-bezier(0.34, 1.56, 0.64, 1); }

    /* Buttons */
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
    .btn { background: var(--primary); color: white; width: 100%; padding: 18px; border-radius: 20px; font-weight: 700; border: none; box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3); cursor: pointer; }
    
    .hidden { display: none; }
    .scroll-wrapper { overflow-x: auto; -webkit-overflow-scrolling: touch; border-radius: 20px; }
    .wide-chart-body { height: 280px; width: 1200px; }
  </style>
</head>
<body onload="init()">
  <div class="tabs">
    <div id="tabHusband" class="tab active" onclick="setUser('husband')">üá∫üá∏ Husband</div>
    <div id="tabWife" class="tab" onclick="setUser('wife')">üáØüáµ Wife</div>
  </div>

  <div class="card">
    <div class="card-label">Consumed Today üçΩÔ∏è</div>
    <div class="card-value" style="color: var(--primary)" id="consumedDisplay">0</div>
    
    <div class="progress-container">
      <div class="progress-text">
        <span id="remainingDisplay">4000 kcal left</span>
        <span id="percentDisplay">0%</span>
      </div>
      <div class="progress-bg">
        <div id="progressBar" class="progress-fill" style="width: 0%"></div>
      </div>
    </div>
  </div>

  <div class="grid">
    <div class="card"><div class="card-label">Daily Goal üéØ</div><div id="goalDisplay" class="card-value">4000</div></div>
    <div class="card" onclick="toggleWeight()"><div class="card-label">Weight ‚úèÔ∏è</div><div class="card-value"><span id="weightDisplay">--</span> <small style="font-size:12px; color:#94a3b8">lbs</small></div></div>
  </div>

  <div id="modeManual" class="card hidden">
    <input type="date" id="mDate" style="width:100%; padding:12px; border-radius:12px; border:1px solid #e2e8f0; margin-bottom:10px;">
    <div class="grid"><input type="number" id="mCals" placeholder="Cals" style="padding:12px; border-radius:12px; border:1px solid #e2e8f0;"><input type="number" id="mProt" placeholder="Prot" style="padding:12px; border-radius:12px; border:1px solid #e2e8f0;"></div>
    <button class="btn" id="logBtn" onclick="submitManual()">Log Meal</button>
  </div>

  <div style="display:flex; gap:12px; margin-bottom:25px;">
    <button class="btn" style="background:#fff; color:var(--text); border:1px solid #e2e8f0;" onclick="setMode('manual')">‚úçÔ∏è Manual Log</button>
    <button class="btn" onclick="takePhoto()">üì∏ AI Photo</button>
  </div>

  <div class="card"><div class="card-label">Performance üî•</div><div class="scroll-wrapper"><div class="wide-chart-body"><canvas id="calChart"></canvas></div></div></div>
  <div class="card"><div class="card-label">Weight Trend üìâ</div><div style="height:200px"><canvas id="weightChart"></canvas></div></div>

  <div id="historyList"></div>

  <script>
    let currentUser = 'husband';
    let weightChartInstance = null;
    let calChartInstance = null;
    const GOALS = { husband: 4000, wife: 2000 };

    function init() { setUser('husband'); }

    function setUser(user) {
      currentUser = user;
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.getElementById(user === 'husband' ? 'tabHusband' : 'tabWife').classList.add('active');
      const tz = user === 'husband' ? 'Pacific/Honolulu' : 'Asia/Tokyo';
      document.getElementById('mDate').value = new Date().toLocaleDateString("en-CA", { timeZone: tz });
      loadStats();
    }

    async function loadStats() {
      const res = await fetch(`/api/stats?user=${currentUser}`);
      const data = await res.json();
      
      const consumed = data.totalCals;
      const goal = GOALS[currentUser];
      const remaining = Math.max(0, goal - consumed);
      const pct = Math.min(100, Math.round((consumed / goal) * 100));

      // Update Screen
      document.getElementById('consumedDisplay').innerText = consumed;
      document.getElementById('remainingDisplay').innerText = remaining + " kcal left";
      document.getElementById('percentDisplay').innerText = pct + "%";
      document.getElementById('progressBar').style.width = pct + "%";
      document.getElementById('weightDisplay').innerText = data.lastWeight || '--';
      
      renderCharts(data);
      renderHistory(data.recentLogs);
    }

    function renderCharts(data) {
        // ... (Keep your working renderCharts logic here)
    }

    function renderHistory(logs) {
        // ... (Keep your working renderHistory logic here)
    }

    async function submitManual() {
      const body = { user: currentUser, item: "Manual Log", calories: document.getElementById('mCals').value, protein: document.getElementById('mProt').value, date: document.getElementById('mDate').value, category: "Manual" };
      await fetch("/api/log/manual", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(body) });
      document.getElementById('modeManual').classList.add('hidden');
      loadStats();
    }

    function setMode(m) { document.getElementById('modeManual').classList.toggle('hidden', m!=='manual'); }
    function toggleWeight() { /* weight input logic */ }
  </script>
</body>
</html>
